<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>java_obf | 一只想登珠峰的猪</title><meta name="description" content="java_obf - chionyuan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="一只想登珠峰的猪"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="一只想登珠峰的猪" type="application/atom+xml">
</head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="一只想登珠峰的猪"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/chionyuan" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">java_obf</h1><div class="post-info"><a></a>2022-07-18</div><div class="post-content"><h1 id="安卓java层混淆"><a href="#安卓java层混淆" class="headerlink" title="安卓java层混淆"></a>安卓java层混淆</h1><p>对于一个应用release包来说，存在混淆效果是十分正常的。添加混淆不仅能够使用无意义的命名去重新命名类、方法及变量，使得应用代码被混淆难以反编译及进行逆向工程，同时在一定程度上还能够减小包的大小。</p>
<p>在Android里面，由于我们常用的IDE:Android Studio集成了ProGuard，因此我们最常用，最简单的混淆是ProGuard混淆。ProGuard混淆主要包括有四个功能：</p>
<ol>
<li>压缩（Shrink）:用于检测和删除没有使用的类、字段、方法和属性。</li>
<li>优化（Optimize）:对于字节码进行优化，并且移除无用指令。</li>
<li>混淆（Obfuscate）:使用a,b,c等名称对类，字段和方法进行重命名。</li>
<li>预检（Preverify）:主要是在Java平台上对处理后的代码进行预检。</li>
</ol>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>Android Studio中集成了ProGuard，因此在项目中默认配置了proguard-rules.pro文件，我们可以直接修改此文件。</p>
<p>Android Studio使用ProGuard主要包括如下几个步骤：</p>
<ol>
<li>配置文件中打开混淆。</li>
<li>配置混淆文件。</li>
<li>检查日志文件，apk文件以及apk运行状况，查询是否有错误出现。</li>
</ol>
<h4 id="一-配置文件中打开混淆"><a href="#一-配置文件中打开混淆" class="headerlink" title="一. 配置文件中打开混淆"></a>一. 配置文件中打开混淆</h4><p>在build.gradle文件中配置如下代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">    debug &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            <span class="comment">//混淆开关</span></span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 是否zip对齐</span></span><br><span class="line">            zipAlignEnabled <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 移除无用的resource文件</span></span><br><span class="line">            shrinkResources <span class="literal">false</span></span><br><span class="line">            <span class="comment">// 是否打开debuggable开关</span></span><br><span class="line">            debuggable <span class="literal">false</span></span><br><span class="line">            <span class="comment">// 是否打开jniDebuggable开关</span></span><br><span class="line">            jniDebuggable <span class="literal">false</span></span><br><span class="line">            proguardFiles <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码中可以看到配置混淆开关的是<code>minifyEnabled</code>,设置为true可以打开混淆。</p>
<p>混淆一般是配置在release包中，原因是因为debug包一般来说是开发者在开发需要时运行调试的，混淆会减慢打包速度，对于开发程序效率有所影响。但是这不表示我们在开发程序时不注重混淆设置，在混淆设置不正确的情况下可能会发生查找不到某个类的异常，因此如果项目中有打开混淆，在需求完成后添加混淆并自测是必要步骤。</p>
<p>在配置文件proguard-rules.pro中，这套基本都是通用的了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># Add project specific ProGuard rules here.</span><br><span class="line"># You can control the set of applied configuration files using the</span><br><span class="line"># proguardFiles setting in build.gradle.</span><br><span class="line">#</span><br><span class="line"># For more details, see</span><br><span class="line">#   http:<span class="comment">//developer.android.com/guide/developing/tools/proguard.html</span></span><br><span class="line"></span><br><span class="line"># If your project uses WebView with JS, uncomment the following</span><br><span class="line"># and specify the fully qualified <span class="keyword">class</span> <span class="title class_">name</span> to the JavaScript interface</span><br><span class="line"># class:</span><br><span class="line">#-keepclassmembers <span class="keyword">class</span> <span class="title class_">fqcn</span>.of.javascript.interface.<span class="keyword">for</span>.webview &#123;</span><br><span class="line">#   <span class="keyword">public</span> *;</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line"># Uncomment <span class="built_in">this</span> to preserve the line number information <span class="keyword">for</span></span><br><span class="line"># debugging stack traces.</span><br><span class="line">#-keepattributes SourceFile,LineNumberTable</span><br><span class="line"></span><br><span class="line"># If you keep the line number information, uncomment <span class="built_in">this</span> to</span><br><span class="line"># hide the original source file name.</span><br><span class="line">#-renamesourcefileattribute SourceFile</span><br><span class="line"></span><br><span class="line">#指定压缩级别</span><br><span class="line">-optimizationpasses <span class="number">5</span></span><br><span class="line"></span><br><span class="line">#不跳过非公共的库的类成员</span><br><span class="line">-dontskipnonpubliclibraryclassmembers</span><br><span class="line"></span><br><span class="line">#混淆时采用的算法</span><br><span class="line">-optimizations !code/simplification/arithmetic,!field<span class="comment">/*,!class/merging/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#把混淆类中的方法名也混淆了</span></span><br><span class="line"><span class="comment">-useuniqueclassmembernames</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#指定不去忽略非公共的库的类</span></span><br><span class="line"><span class="comment">-dontskipnonpubliclibraryclasses</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#不做预检验，preverify是proguard的四大步骤之一,可以加快混淆速度</span></span><br><span class="line"><span class="comment">#-dontpreverify</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 忽略警告（？）</span></span><br><span class="line"><span class="comment">#-ignorewarnings</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#混淆时不使用大小写混合，混淆后的类名为小写(大小写混淆容易导致class文件相互覆盖）</span></span><br><span class="line"><span class="comment">-dontusemixedcaseclassnames</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#优化时允许访问并修改有修饰符的类和类的成员</span></span><br><span class="line"><span class="comment">-allowaccessmodification</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#将文件来源重命名为“SourceFile”字符串</span></span><br><span class="line"><span class="comment">#-renamesourcefileattribute SourceFile</span></span><br><span class="line"><span class="comment">#保留行号</span></span><br><span class="line"><span class="comment">-keepattributes SourceFile,LineNumberTable</span></span><br><span class="line"><span class="comment">#保持泛型</span></span><br><span class="line"><span class="comment">-keepattributes Signature</span></span><br><span class="line"><span class="comment"># 保持注解</span></span><br><span class="line"><span class="comment">-keepattributes *Annotation*,InnerClasses</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 保持测试相关的代码</span></span><br><span class="line"><span class="comment">-dontnote junit.framework.**</span></span><br><span class="line"><span class="comment">-dontnote junit.runner.**</span></span><br><span class="line"><span class="comment">-dontwarn android.test.**</span></span><br><span class="line"><span class="comment">-dontwarn android.support.test.**</span></span><br><span class="line"><span class="comment">-dontwarn org.junit.**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 混淆字典</span></span><br><span class="line"><span class="comment">-obfuscationdictionary dic.txt</span></span><br><span class="line"><span class="comment">-classobfuscationdictionary dic.txt</span></span><br><span class="line"><span class="comment">-packageobfuscationdictionary dic.txt</span></span><br></pre></td></tr></table></figure>

<p>—————-以上摘自：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e01f547979bb">https://www.jianshu.com/p/e01f547979bb</a> ———————</p>
<p>配置目录截图：</p>
<p><img src="/images/pasted-2.png" alt="upload successful"></p>
<p>其中dic.txt的生成脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="comment"># 混淆字典生成</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">length = <span class="number">10</span></span><br><span class="line">result = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">keys = [<span class="string">&quot;U&quot;</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;V&quot;</span>,<span class="string">&quot;u&quot;</span>]</span><br><span class="line"><span class="comment">#也可以使用 I，i，L，l，1这种。</span></span><br><span class="line"><span class="comment">#因开发者而异，怎么恶心怎么来</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line">    <span class="comment"># 长度 7- 13 位</span></span><br><span class="line">    <span class="keyword">for</span> length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>,<span class="number">13</span>):</span><br><span class="line">        <span class="comment"># 按照长度随机拼接</span></span><br><span class="line">        temp = keys[random.randint(<span class="number">0</span>,<span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length+<span class="number">1</span>):</span><br><span class="line">            temp += random.choice(keys)</span><br><span class="line">        result.add(temp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;成功生成字典，数量：&quot;</span>, <span class="built_in">len</span>(result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;dic.txt&quot;</span>,mode=<span class="string">&#x27;w+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.writelines(<span class="string">&quot;\n&quot;</span>.join(result))</span><br><span class="line">    f.flush()</span><br></pre></td></tr></table></figure>



<p>混淆之前，反编译出来的代码基本和源码一样。很容易被窥探代码逻辑。<br><img src="/images/pasted-1.png" alt="upload successful"></p>
<p>混淆成功之后，混乱不堪。<br><img src="/images/pasted-0.png" alt="upload successful"></p>
<p>但是字符串还是没混淆，通过一些特征还是可以分析的。<br>之前用过stringfog这个工具，后来由于没怎么更新，不兼容新的gradle版本，因此也没时间二次开发。</p>
<p>有能力的可进行stringfog的二次开发，原理都一样，据所知某些加固产品，也是基于这些方法实现。</p>
<p>StringFOG: <a target="_blank" rel="noopener" href="https://github.com/MegatronKing/StringFog">https://github.com/MegatronKing/StringFog</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/MichaelRocks/paranoid">https://github.com/MichaelRocks/paranoid</a>  用<strong>paranoid</strong>代替。<br><strong>优点：兼容性高，灵活配置</strong><br><strong>缺点：不能全局加密，只能选择某个class下的字符串加密</strong></p>
<p>具体配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In order to make Paranoid work with your project you have to apply the Paranoid Gradle plugin to the project. Please notice that the Paranoid plugin must be applied after the Android plugin.</span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dependencies &#123;</span><br><span class="line">    classpath <span class="string">&#x27;io.michaelrocks:paranoid-gradle-plugin:0.3.7&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;io.michaelrocks.paranoid&#x27;</span></span><br></pre></td></tr></table></figure>



<p>加密完就是这样子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UvvuvUuuVVvu</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: UvvuvUuuVVvu  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">f4695UvvuvUuuVVvu</span> <span class="operator">=</span> UVUvvvUUvU.UvvuvUuuVVvu.UvvuvUuuVVvu(-<span class="number">2238559751030696372L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UVUvvvUUvU.UvvuvUuuVVvu.UvvuvUuuVVvu(-<span class="number">2238559712375990708L</span>);</span><br><span class="line">        UVUvvvUUvU.UvvuvUuuVVvu.UvvuvUuuVVvu(-<span class="number">2238559699491088820L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说实话，我已经不想分析了，虽然用jeb也能自动还原。但面对庞大的apk的时候，jeb的性能就不是这么高了。</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/07/19/algorithm-gen/">prev</a><a class="next" href="/2022/07/16/common-algorithm/">next</a></div><div class="copyright"><p>&copy; 2023 <a href="http://chionyuan.github.io">niceboy</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://chionyuan.github.io" target="_blank">chionyuan</a>.</p></div></footer></div></body></html>